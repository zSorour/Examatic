# Building a VM Image (Server Template) Using Packer

By automating the process of creating VM images using packer, the generated images can act as templates that are pre-configured and ready to be instantiated by Terraform on-demand.

Technically, a VM image is generated by Packer after going through the following steps:

1. Creation of a temporary cloud instance based on a standard baseline Amazon Machine Image (AMI).
2. Running “provisioners” which could be as simple as basic scripts, or as advanced as Ansible configuration files. Typically, provisioners connect to the temporary instance via SSH or WinRM protocols based on the target instance’s operating system.
3. Creation and registration of an AMI based on the provisioner configurations.
4. Destroy the temporary cloud instance.

![Flow of executing packer template files.](https://github.com/zSorour/Examatic/blob/master/images/Flow%20of%20Executing%20Packer%20Template%20Files.png?raw=true 'Flow of executing packer template files.')

## Ansible Playbook

Various Ansible roles have been written to configure the instance correctly in terms of having an admin user, user, installing visual studio, and a [windows-common role](https://github.com/zSorour/Examatic/blob/master/packer-windows-vs-template/ansible/roles/windows-common/tasks/main.yml) that includes a bunch of tasks related to setting up the windows instance with essential software. Most importantly, this file contains the configuration of the VNC Server and WebSockets/TCP VNC Proxy server that allows the students to connect to the instance when it is provisioned via VNC. More details could be found below.

### Configuration of VNC Server and WebSockets/TCP VNC Proxy Server

Students would typically connect to the cloud instance through a VNC client integrated into the proposed React web application allowing them to have full GUI access and control over the cloud instance conveniently within their web browser. Therefore, we use Ansible to install a VNC Server on the temporary instance created by packer for AMI generation. TightVNC is an open-source software-based VNC server compatible with both Windows and Linux, hence, it has been chosen as a VNC Server for the project’s use case.

Using Ansible, we can define a task that utilizes the “win_get_url” module to download the TightVNC installer from their official website. Followed by a task that utilizes the “win_package” module, we instruct Ansible to install TightVNC downloaded from the previous task. Specific TightVNC arguments can be passed to specify advanced installation options such as setting the VNC RFB Port to 5900, setting the default VNC authentication password, adding Firewall exceptions, etc

However, since students would be connecting from a web browser, having a VNC Server is not enough. Due to a limitation in web browsers, there is no way to communicate through the VNC protocol directly. Instead, HTML5 Canvas and WebSockets are used. One famous and widely used browser-based VNC client that utilizes HTML5 Canvas and WebSockets is the [open-source noVNC project](https://github.com/novnc/noVNC). Thus, to make the VNC server compatible with the browser based VNC client that uses WebSockets, a WebSocket to TCP proxy server is required. Hence, besides installing the TightVNC server using Ansible, [WebSockify](https://github.com/novnc/websockify) software-based proxy server must also be installed. By placing the proxy server in the middle of the communication between the browser client and the TightVNC server, students will be able to display and control the cloud instance desktop right from their browser.

To correctly configure WebSockify, multiple granular tasks have been written and included in the common Ansible role. For instance, one task utilizes the “win_firewall_rule” module to apply a Windows Firewall rule that enables port 6080. This is a necessary step since the port is disabled by default. To start the WebSockify proxy server, a batch script file (websockify.bat) has been created to invoke WebSockify’s python script with the following configurations:

- Listen to incoming WebSocket connections on port 6080.
- Bridge TCP traffic to localhost port 5900.

![Using a WebSocket to TCP Proxy between a noVNC Client and a VNC Server](https://github.com/zSorour/Examatic/blob/master/images/WebSockify%20Proxy.png?raw=true 'Using a WebSocket to TCP Proxy between a noVNC Client and a VNC Server')

To start the WebSockify server on Windows startup, a task has been defined in Ansible to run the (websockify.bat) file on system boot using the “win_scheduled_task” Ansible module which configures Windows Task Scheduler accordingly.
